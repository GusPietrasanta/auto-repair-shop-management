@page "/Jobs"
@inject AuthenticationStateProvider GetAuthenticationStateAsync
@inject IAppointmentDataService appointmentData
@inject IMechanicSessionData mechanicSession
@inject NavigationManager NavigationManager
@attribute [Authorize(Roles = "Mechanic")]

<PageTitle>Assigned Jobs</PageTitle>

<h1 class="text-center">View Assigned Job Cards</h1>

<div class="row justify-content-center">
	<div class="col-6">

		@if (mechanicSession.GetAppointmentToWorkOn() != null)
		{
			<h3>Inspection Report for vehicle @mechanicSession.GetAppointmentToWorkOn().NumberPlate successfully submitted!</h3>
		}

		@if (appointments == null)
		{
			<p>Loading appointments...</p>
		}
		else
		{
			@foreach (var a in appointments)
			{
				<div class="alert alert-info text-center">
					@*<p>Report ID: @r.ID</p>*@
					<p>
						Appointment ID: @a.ID <br>
						Date: @a.Date.ToShortDateString() <br>
						Customer: @a.FirstName @a.LastName <br>
						Vehicle: @a.NumberPlate <br>
						@a.Make - @a.Model <br>
					</p>
					<button class="btn btn-success" @onclick="(() => GoToReportForm(a))">Start Job</button>
				</div>
			}
		}

	</div>
</div>


@code {
	private List<IDetailedAppointment> appointments;
	private string userName;

	protected async override Task OnInitializedAsync()
	{
		var authstate = await GetAuthenticationStateAsync.GetAuthenticationStateAsync();
		var user = authstate.User;
		userName = user.Identity.Name;

		appointments = await appointmentData.ReadAllAppointmentsDetailedByUserName(userName);
	}

	private void GoToReportForm(IDetailedAppointment appointmentDetails)
	{
		mechanicSession.SetAppointmentToWorkOn(appointmentDetails);
		NavigationManager.NavigateTo("/ReportForm");
	}
}